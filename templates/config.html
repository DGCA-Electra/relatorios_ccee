{% extends 'base.html' %}
{% block title %}ConfiguraÃ§Ãµes{% endblock %}
{% block page_title %}ConfiguraÃ§Ãµes do Sistema{% endblock %}

{% block content %}
<form method="post">
  {% for tipo, cfg in configs.items() %}
  <div class="config-form">
    <h3>ğŸ“‹ {{ tipo }}</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>ğŸ“Š Arquivo Excel (Dados):</label>
        <div style="display: flex; align-items: center;">
          <input type="text" name="{{ tipo }}_excel_dados" value="{{ cfg.excel_dados }}" required>
          <button type="button" class="test-btn" onclick="testPath('{{ tipo }}_excel_dados')">Testar</button>
          <span id="{{ tipo }}_excel_dados_status" class="status"></span>
        </div>
      </div>
      <div class="form-group">
        <label>ğŸ“§ Arquivo Excel (Contatos):</label>
        <div style="display: flex; align-items: center;">
          <input type="text" name="{{ tipo }}_excel_contatos" value="{{ cfg.excel_contatos }}" required>
          <button type="button" class="test-btn" onclick="testPath('{{ tipo }}_excel_contatos')">Testar</button>
          <span id="{{ tipo }}_excel_contatos_status" class="status"></span>
        </div>
      </div>
      <div class="form-group">
        <label>ğŸ“„ Aba da Planilha de Dados:</label>
        <input type="text" name="{{ tipo }}_sheet_dados" value="{{ cfg.sheet_dados }}" required>
      </div>
      <div class="form-group">
        <label>ğŸ‘¤ Aba da Planilha de Contatos:</label>
        <input type="text" name="{{ tipo }}_sheet_contatos" value="{{ cfg.sheet_contatos }}" required>
      </div>
      <div class="form-group">
        <label>ğŸ“ DiretÃ³rio PDFs:</label>
        <div style="display: flex; align-items: center;">
          <input type="text" name="{{ tipo }}_pdfs_dir" value="{{ cfg.pdfs_dir }}">
          <button type="button" class="test-btn" onclick="testPath('{{ tipo }}_pdfs_dir')">Testar</button>
          <span id="{{ tipo }}_pdfs_dir_status" class="status"></span>
        </div>
      </div>
      <div class="form-group">
        <label for="{{ tipo }}_header_row">#ï¸âƒ£ Linha do CabeÃ§alho (inicia em 0):</label>
        <input type="number" name="{{ tipo }}_header_row" value="{{ cfg.header_row }}" required min="0"
          style="font-size: 16px; padding: 12px 16px;">
      </div>
      <div class="form-group" style="grid-column: 1 / -1;">
        <label for="{{ tipo }}_data_columns">ğŸ—ºï¸ Mapeamento de Colunas (Excel:PadrÃ£o, ...):</label>
        <input type="text" name="{{ tipo }}_data_columns" value="{{ cfg.data_columns }}" required>
      </div>
    </div>
  </div>
  {% endfor %}
  <button type="submit" class="save-btn">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
</form>
{% endblock %}

{% block scripts %}
<script>
  function testPath(fieldName) {
    const input = document.querySelector(`input[name="${fieldName}"]`);
    const statusSpan = document.getElementById(`${fieldName}_status`);
    if (!input || !statusSpan) return;
    const path = input.value;
    if (!path) { statusSpan.textContent = ''; return; }
    statusSpan.textContent = '...';
    fetch('/test_path', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: path })
    }).then(r => r.json()).then(d => {
      statusSpan.textContent = d.exists ? 'âœ…' : 'âŒ';
      statusSpan.className = d.exists ? 'status exists' : 'status not-exists';
    });
  }
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.test-btn').forEach(btn => btn.click());
  });
</script>
{% endblock %}